<?php
/* @var $assessmentViewModel Assessment_ViewModel_Assessment */
$assessmentViewModel = $this->assessmentViewModel;
$brandName = My_Brand::$brandName;
$companyName = My_Brand::$companyName;
$this->headLink()->appendStylesheet($this->theme("proposalgenerator/reports/grossmargin/grossmargin_html.css"));
?>
<div class="container" id="htmlReportContainer">
<div>
    <h2 class="reportTitle">Gross Margin Report</h2><br />
    <em>AMPV = Average Monthly Page Volume</em>
</div>

<br />

<table id="grossMarginInformation">
    <tbody>
    <tr>
        <td class="column1">
            <div class="heading"><?php echo $brandName ?> Black And White CPP:</div>
        </td>
        <td class="column2">
            <div>$<?php echo number_format($assessmentViewModel->getMPSBlackAndWhiteCPP(), 4); ?></div>
        </td>
        <td class="column3">
            <div class="heading">Total Cost:</div>
        </td>
        <td class="column4">
            <div>$<?php echo number_format($assessmentViewModel->getGrossMarginTotalMonthlyCost()->Combined, 2); ?></div>
        </td>
    </tr>
    <tr>
        <td class="column1">
            <div class="heading"><?php echo $brandName ?> Color CPP:</div>
        </td>
        <td class="column2">
            <div>$<?php echo number_format($assessmentViewModel->getMPSColorCPP(), 4); ?></div>
        </td>
        <td class="column3">
            <div class="heading">Total Revenue:</div>
        </td>
        <td class="column4">
            <div>$<?php echo number_format($assessmentViewModel->getGrossMarginTotalMonthlyRevenue()->Combined, 2); ?></div>
        </td>
    </tr>
    <tr>
        <td class="column1">
            <div class="heading">Weighted Black And White CPP:</div>
        </td>
        <td class="column2">
            <div>$<?php echo number_format($assessmentViewModel->getGrossMarginWeightedCPP()->BlackAndWhite, 4); ?></div>
        </td>
        <td class="column3">
            <div class="heading">Monthly Profit:</div>
        </td>
        <td class="column4">
            <div>$<?php echo number_format($assessmentViewModel->getGrossMarginMonthlyProfit(), 2); ?></div>
        </td>
    </tr>
    <tr>
        <td class="column1">
            <div class="heading">Weighted Color CPP:</div>
        </td>
        <td class="column2">
            <div>$<?php echo number_format($assessmentViewModel->getGrossMarginWeightedCPP()->Color, 4); ?></div>
        </td>
        <td class="column3">
            <div class="heading">Overall Margin:</div>
        </td>
        <td class="column4">
            <div><?php echo number_format($assessmentViewModel->getGrossMarginOverallMargin()); ?>%</div>
        </td>
    </tr>
    <tr>
        <td class="column1">
            <div class="heading">Black And White Margin:</div>
        </td>
        <td class="column2">
            <div><?php echo number_format($assessmentViewModel->getGrossMarginBlackAndWhiteMargin()); ?>%</div>
        </td>
        <td class="column3">
            <div class="heading">Color Margin:</div>
        </td>
        <td class="column4"><?php echo number_format($assessmentViewModel->getGrossMarginColorMargin()); ?>%</td>
    </tr>
    </tbody>
</table>

<br />

<div class="center">
    <em class="center">Yellow highlighted rows indicate devices that have not been assigned toners matching your selected first toner vendor preference.<br />
        For these devices the system has selected the best available alternative based on your preference.</em>
    <br /><br />
</div>

<table id="grossMarginDeviceSummary">
    <thead>
    <tr class="center">
        <th class="column1" rowspan="2">Device Name<br />(IP Address - Serial Number)</th>
        <th colspan="5">Black And White</th>
        <th colspan="5">Color</th>
    </tr>
    <tr class="center">
        <th class="column2">AMPV</th>
        <th class="column3">Toner Cost</th>
        <th class="column4">Toner Yield</th>
        <th class="column5">CPP</th>
        <th class="column6">Total Printing Cost</th>
        <th class="column7">AMPV</th>
        <th class="column8">Toner Cost</th>
        <th class="column9">Toner Yield</th>
        <th class="column10">CPP</th>
        <th class="column11">Total Printing Cost</th>
    </tr>
    </thead>
    <tbody>
    <?php foreach ($assessmentViewModel->getDevices()->purchasedDeviceInstances->getDeviceInstances() as $deviceInstance) : ?>
        <?php
        $tonerConfig               = $deviceInstance->getMasterDevice()->tonerConfigId;
        $dealerCostPerPageSettings = $assessmentViewModel->getCostPerPageSettingForDealer();
        $completeMonoToners        = $deviceInstance->getMasterDevice()->getHasValidMonoGrossMarginToners($assessmentViewModel->getCostPerPageSettingForDealer());
        $completeColorToners       = $deviceInstance->getMasterDevice()->getHasValidColorGrossMarginToners($assessmentViewModel->getCostPerPageSettingForDealer());
        $blackToner                = null;
        $colorToner                = null;
        $toners                    = $deviceInstance->getMasterDevice()->getCheapestTonerSetByVendor($assessmentViewModel->getCostPerPageSettingForDealer());

        foreach ($toners as $toner)
        {
            switch ($toner->tonerColorId)
            {
                case Proposalgen_Model_TonerColor::BLACK:
                    $blackToner = $toner;
                    break;
                case Proposalgen_Model_TonerColor::CYAN:
                case Proposalgen_Model_TonerColor::MAGENTA:
                case Proposalgen_Model_TonerColor::YELLOW:
                    $colorToner = $toner;
                    break;
                case Proposalgen_Model_TonerColor::THREE_COLOR:
                    $colorToner = $toner;
                    break;
                case Proposalgen_Model_TonerColor::FOUR_COLOR:
                    $blackToner = $toner;
                    $colorToner = $toner;
                    break;
                default:
                    break;
            }
        }

        // Black Toner
        $blackCost  = "$" . number_format($blackToner->calculatedCost, 2);
        $blackYield = number_format($blackToner->yield);

        // Color Toner
        $colorCost  = "-";
        $colorStyle = "style='text-align: center;'";
        $colorYield = "-";
        $isColor    = false;
        if ($colorToner instanceof Proposalgen_Model_Toner)
        {
            $colorCost  = "$" . number_format($colorToner->cost, 2);
            $colorYield = number_format($colorToner->yield);
            $colorStyle = 'right';
            $isColor    = true;
        }
        ?>
        <tr class="<?php echo ($completeMonoToners) ? "" : "nonCompliantMono" ?> <?php echo ($completeColorToners) ? "" : "nonCompliantColor" ?>">
            <!-- Monochrome -->
            <td class="column1">
                <div><?php echo str_ireplace("hewlett-packard", "HP", $deviceInstance->getDeviceName()) . "<br />(" . $deviceInstance->ipAddress . " - " . $deviceInstance->serialNumber . ")"; ?></div>
            </td>
            <td class="column2 mono">
                <div class="right"><?php echo number_format($deviceInstance->getPageCounts()->getBlackPageCount()->getMonthly()); ?></div>
            </td>

            <td class="column3 mono">
                <div class="right"><?php echo $blackCost ?></div>
            </td>
            <td class="column4 mono">
                <div class="right"><?php echo $blackYield ?></div>
            </td>
            <td class="column5 mono">
                <div class="right"><?php echo number_format($deviceInstance->calculateCostPerPage($assessmentViewModel->getCostPerPageSettingForDealer())->monochromeCostPerPage, 4); ?></div>
            </td>
            <td class="column6 mono">
                <div class="right">
                    $<?php echo number_format($deviceInstance->getMonthlyBlackAndWhiteCost($assessmentViewModel->getCostPerPageSettingForDealer()), 2); ?></div>
            </td>

            <!-- Color -->
            <td class="column7 color">
                <div class="<?php echo $colorStyle; ?>"><?php echo ($isColor) ? number_format($deviceInstance->getPageCounts()->getColorPageCount()->getMonthly()) : "-"; ?></div>
            </td>
            <td class="column8 color">
                <div class="<?php echo $colorStyle; ?>"><?php echo $colorCost ?></div>
            </td>
            <td class="column9 color">
                <div class="<?php echo $colorStyle; ?>"><?php echo $colorYield ?></div>
            </td>

            <td class="column10 color">
                <div class="<?php echo $colorStyle; ?>"><?php echo ($isColor) ? number_format($deviceInstance->calculateCostPerPage($assessmentViewModel->getCostPerPageSettingForDealer())->colorCostPerPage, 4) : "-"; ?></div>
            </td>

            <td class="column11 color">
                <div class="<?php echo $colorStyle; ?>"><?php echo ($isColor) ? "$" . number_format($deviceInstance->calculateMonthlyColorCost($assessmentViewModel->getCostPerPageSettingForDealer()), 2) : "-"; ?></div>
            </td>
        </tr>
    <?php endforeach; ?>
    <tr class="totals">
        <td class="column1">
            <div>Totals for <?php echo $assessmentViewModel->getDevices()->purchasedDeviceInstances->getCount(); ?> devices:</div>
        </td>
        <td>
            <div class="right"><?php echo number_format($assessmentViewModel->getDevices()->purchasedDeviceInstances->getPageCounts()->getBlackPageCount()->getMonthly()); ?></div>
        </td>
        <td colspan="3"></td>
        <td class="column2">
            <div class="right">$<?php echo number_format($assessmentViewModel->getGrossMarginTotalMonthlyCost()->BlackAndWhite, 2); ?></div>
        </td>
        <td>
            <div class="center"><?php echo number_format($assessmentViewModel->getDevices()->purchasedDeviceInstances->getPageCounts()->getColorPageCount()->getMonthly()); ?></div>
        </td>
        <td colspan="3"></td>
        <td>
            <div class="right">$<?php echo number_format($assessmentViewModel->getGrossMarginTotalMonthlyCost()->Color, 2); ?></div>
        </td>
    </tr>
    </tbody>
</table>
</div>