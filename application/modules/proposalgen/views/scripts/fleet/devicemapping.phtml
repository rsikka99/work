<?php
/**
 * devicemapping.phtml
 */
?>

<?php $this->headScript()->captureStart('append','text/javascript') ?>
	var show_mapped = false;
	var grid_display = '<?php echo $this->grid; ?>';

    $(document).ready(function() {
		//find center screen for modal popup
		var sTop = ($(window).height()/2)-100;
		var sLeft = ($(window).width()/2)-200;
		
		jQuery("#results_list").jqGrid({
			url:'<?php echo $this->url(array('action' => 'devicemappinglist')); ?>',
			datatype:'json',
			colNames:['UDCID','Devices PF ID','Count','Import Printer Name','Mapped To ID','Mapped To Modelname','Mapped To Manufacturer','Master Printer Name','Is Added','Action'],
			colModel:[
				{tag:0, width: 10, name:'upload_data_collector_row_id', index:'upload_data_collector_row_id', hidden:true, title:false, sortable:false},
				{tag:1, width: 10, name:'devices_pf_id', index:'devices_pf_id', hidden:true, title:false, sortable:false},
				{tag:2, width: 40, name:'count', index:'count', align:'center', title:false, sortable:false},
				{tag:3, width: 200, name:'imported_devicename', index:'imported_devicename', title:false, sortable:false},
				{tag:4, width: 10, name:'mapped_to_id', index:'mapped_to_id', hidden:true, sortable:false},
				{tag:5, width: 10, name:'mapped_to_modelname', index:'mapped_to_modelname', hidden:true, sortable:false},
				{tag:6, width: 10, name:'mapped_to_manufacturer', index:'mapped_to_manufacturer', hidden:true, sortable:false},
				{tag:7, width: 250, name:'master_device_id', index:'master_device_id', align:'center', sortable:false},
				{tag:8, width: 10, name:'is_added', index:'is_added', hidden:true, title:false, sortable:false},
				{tag:9, width: 50, name:'action', index:'action', align:'center', title:false, sortable:false}
			],
			width:940,
			height:400,
			rowNum: -1,
			gridComplete:function(){ 
				var ids = jQuery("#results_list").jqGrid('getDataIDs');
				for(var i=0; i < ids.length; i++) {
					var cur_row = ids[i];
					var upload_data_collector_row_id = document.getElementById("results_list").rows[i+1].cells[0].innerHTML;
					var devices_pf_id = document.getElementById("results_list").rows[i+1].cells[1].innerHTML;
					var is_added = document.getElementById("results_list").rows[i+1].cells[8].innerHTML;
					var mapped_to_id = document.getElementById("results_list").rows[i+1].cells[4].innerHTML;
					var mapped_to_modelname = document.getElementById("results_list").rows[i+1].cells[5].innerHTML;
					var mapped_to_manufacturer = document.getElementById("results_list").rows[i+1].cells[6].innerHTML;
					var mapped_to_deviceName = mapped_to_manufacturer + " " + mapped_to_modelname;
					mapped_to_deviceName = mapped_to_deviceName.replace("&nbsp; &nbsp;", "");
					
					edit_button = '<input title="Edit Printer" type="button" name="btnEdit'+devices_pf_id+'" id="btnEdit'+devices_pf_id+'" onclick="javascript: add_device('+upload_data_collector_row_id+');" value="Edit" class="btn" />';
					add_button = '<input title="Add New Printer" type="button" name="btnAdd'+devices_pf_id+'" id="btnAdd'+devices_pf_id+'" onclick="javascript: add_device('+upload_data_collector_row_id+');" value="Add" class="btn" />';
					
					if(is_added > -1) {
						//display message instead of dropdown
						master_device_dropdown = "New Printer Added (<a href=\"javascript: void(0);\" onclick=\"javascript: remove_device("+devices_pf_id+",'results');\">Click to Remove</a>)";
						jQuery("#results_list").jqGrid('setRowData',ids[i],{action: edit_button});
					} else {
						master_device_dropdown = '';
						master_device_dropdown += '<input type="hidden" name="hdnDevicesPfId'+devices_pf_id+'" id="hdnDevicesPfId'+devices_pf_id+'" class="devicesPfId" value="'+devices_pf_id+'" />';
						master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesValue'+devices_pf_id+'" id="hdnMasterDevicesValue'+devices_pf_id+'" class="masterDeviceId" value="'+mapped_to_id+'" />';
						master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesText'+devices_pf_id+'" id="hdnMasterDevicesText'+devices_pf_id+'" class="masterDeviceName" value="'+mapped_to_deviceName+'" />';
						master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesManufacturer'+devices_pf_id+'" id="hdnMasterDevicesManufacturer'+devices_pf_id+'" class="manufacturerName" value="'+mapped_to_manufacturer+'" />';
						master_device_dropdown += '<input type="text" name="txtMasterDevices'+devices_pf_id+'" id="txtMasterDevices'+devices_pf_id+'" class="span5 autoCompleteDeviceName" value="'+mapped_to_deviceName+'" />';
						jQuery("#results_list").jqGrid('setRowData',ids[i],{action: add_button});
					}
					jQuery("#results_list").jqGrid('setRowData',ids[i],{master_device_id: master_device_dropdown});
					
					$(".autoCompleteDeviceName").autocomplete({
            			source: function (request, response) {
                        	$.ajax({
                            	url: "<?php echo $this->url(array('action' => 'getmodels')); ?>", dataType: "json",
                                data: { searchText: request.term },
                                success: function (data) {
                                	response($.map(data, function (item) {
                                    	return {
                                        	value: item.label,
                                            id: item.value,
                                            label: item.label,
                                            manufacturer: item.manufacturer
                                        }
                                    }))
                                }
                            })
            			},
            			minLength: 0,
            			select: function( event, ui ) {
            				$(this).parent().find("input.masterDeviceId")[0].value = ui.item.id;
            				$(this).parent().find("input.masterDeviceName")[0].value = ui.item.label;
            				$(this).parent().find("input.manufacturerName")[0].value = ui.item.manufacturer;
            				
            				var textValue = $.trim(this.value);
            				var row_id = this.id.replace("txtMasterDevices","");
            				var deviceId = $.trim($(this).parent().find("input.masterDeviceId")[0].value);
            				var deviceName = $.trim($(this).parent().find("input.masterDeviceName")[0].value);
            			
            				// If the user textbox is filled
            				if (textValue) {
            					// If the device id is not set, then we reset to blank
								if (!deviceId) {
									textValue = "";
								} else {
									// Set the name to the device name
									textValue = deviceName;
                            	}
            				} else {
            					$(this).parent().find("input.masterDeviceId")[0].value = "";
								$(this).parent().find("input.masterDeviceName")[0].value = "";
								$(this).parent().find("input.manufacturerName")[0].value = "";
            				}
            				
            				this.value = textValue;
            				set_mapped(row_id);
            			},
            			open: function( event, ui ) {
                			var termTemplate = '<strong>%s</strong>';
                			var autocompleteData = $(this).data('autocomplete');
                			autocompleteData.menu.element.find('a').each(function() {
                    			var label = $(this);
                				var regex = new RegExp(autocompleteData.term, "gi");
                    			label.html( label.text().replace(regex, function (matched) {
                        			return termTemplate.replace('%s', matched);
                    			}));
                			});
        				},
            			change: function( event, ui ) {
            				var textValue = $.trim(this.value);
            				var row_id = this.id.replace("txtMasterDevices","");
            				var deviceId = $.trim($(this).parent().find("input.masterDeviceId")[0].value);
            				var deviceName = $.trim($(this).parent().find("input.masterDeviceName")[0].value);
            			
            				// If the user textbox is filled
            				if (textValue) {
            					// If the device id is not set, then we reset to blank
								if (!deviceId) {
									textValue = "";
								} else {
									// Set the name to the device name
									textValue = deviceName;
                            	}
            				} else {
            					$(this).parent().find("input.masterDeviceId")[0].value = "";
								$(this).parent().find("input.masterDeviceName")[0].value = "";
								$(this).parent().find("input.manufacturerName")[0].value = "";
            				}
            				
            				this.value = textValue;
            				set_mapped(row_id);
            			}
            		});
				}
			},
			editurl:'dummy.php'
		});
		
		jQuery("#results_list").jqGrid('navGrid','#results_pager',
				{add:false,del:false,edit:false,refresh:false,search:false},
				{closeAfterEdit:true,recreateForm:true,closeOnEscape:true,width:400,top:sTop,left:sLeft},
				{closeAfterAdd:true,recreateForm:true,closeOnEscape:true,width:400,top:sTop,left:sLeft},
				{},
				{},
				{}
		);
		
		jQuery("#mapped_list").jqGrid({
			url:"<?php echo $this->url(array('action' => 'mastermappinglist')); ?>",
			datatype:'local',
			colNames:['UDCID','Devices PF ID','Count','Import Printer Name','Mapped To ID','Mapped To Modelname','Mapped To Manufacturer','Master Printer Name','Is Added','Action'],
			colModel:[
				{tag:0, width: 10, name:'upload_data_collector_row_id', index:'upload_data_collector_row_id', hidden:true, title:false, sortable:false},
				{tag:1, width: 10, name:'devices_pf_id', index:'devices_pf_id', hidden:true, title:false, sortable:false},
				{tag:2, width: 40, name:'count', index:'count', align:'center', title:false, sortable:false},
				{tag:3, width: 200, name:'imported_devicename', index:'imported_devicename', title:false, sortable:false},
				{tag:4, width: 10, name:'mapped_to_id', index:'mapped_to_id', hidden:true, sortable:false},
				{tag:5, width: 10, name:'mapped_to_modelname', index:'mapped_to_modelname', hidden:true, sortable:false},
				{tag:6, width: 10, name:'mapped_to_manufacturer', index:'mapped_to_manufacturer', hidden:true, sortable:false},
				{tag:7, width: 250, name:'master_device_id', index:'master_device_id', align:'center', sortable:false},
				{tag:8, width: 10, name:'is_added', index:'is_added', hidden:true, title:false, sortable:false},
				{tag:9, width: 50, name:'action', index:'action', align:'center', title:false, sortable:false}
			],
			width:940,
			height:400,
			rowNum: -1,
			gridComplete:function(){
				var ids = jQuery("#mapped_list").jqGrid('getDataIDs');
				for(var i=0; i < ids.length; i++) {
					var cur_row = ids[i];
					var upload_data_collector_row_id = document.getElementById("mapped_list").rows[i+1].cells[0].innerHTML;
					var devices_pf_id = document.getElementById("mapped_list").rows[i+1].cells[1].innerHTML;
					var is_added = document.getElementById("mapped_list").rows[i+1].cells[8].innerHTML;
					var mapped_to_id = document.getElementById("mapped_list").rows[i+1].cells[4].innerHTML;
					var mapped_to_modelname = document.getElementById("mapped_list").rows[i+1].cells[5].innerHTML;
					var mapped_to_manufacturer = document.getElementById("mapped_list").rows[i+1].cells[6].innerHTML;
					var mapped_to_deviceName = mapped_to_manufacturer + " " + mapped_to_modelname;
					mapped_to_deviceName = mapped_to_deviceName.replace("&nbsp; &nbsp;", "");
					
					disable = '';
					if (mapped_to_deviceName == '') {
						disable = 'disabled="disabled"';
					}
					<?php if(isset($this->privilege) && in_array("System Admin", $this->privilege)) { ?>
    					edit_button = '<input title="Edit Printer" type="button" name="btnEdit'+devices_pf_id+'" id="btnEdit'+devices_pf_id+'" onclick="javascript: edit_device('+devices_pf_id+');" value="Edit" '+disable+' class="btn" />';
    					add_button = '<input title="Edit Printer" type="button" name="btnAdd'+devices_pf_id+'" id="btnAdd'+devices_pf_id+'" onclick="javascript: edit_device('+devices_pf_id+');" value="Edit" '+disable+' class="btn" />';
                    <?php } else { ?>
    					edit_button = '<input title="Edit Printer" type="button" name="btnEdit'+devices_pf_id+'" id="btnEdit'+devices_pf_id+'" onclick="javascript: add_device('+upload_data_collector_row_id+');" value="Edit" '+disable+' class="btn" />';
    					add_button = '<input title="Add New Printer" type="button" name="btnAdd'+devices_pf_id+'" id="btnAdd'+devices_pf_id+'" onclick="javascript: add_device('+upload_data_collector_row_id+');" value="Add" '+disable+' class="btn" />';
                    <?php } ?>
                    
					if(is_added > -1) {
						//display message instead of dropdown
						master_device_dropdown = "New Printer Added (<a href=\"javascript: void(0);\" onclick=\"javascript: remove_device("+devices_pf_id+",'mapped');\">Click to Remove</a>)";
						jQuery("#mapped_list").jqGrid('setRowData',ids[i],{action: edit_button});
					} else {
						master_device_dropdown = '';
						master_device_dropdown += '<input type="hidden" name="hdnDevicesPfId'+devices_pf_id+'" id="hdnDevicesPfId'+devices_pf_id+'" class="devicesPfId" value="'+devices_pf_id+'" />';
						master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesValue'+devices_pf_id+'" id="hdnMasterDevicesValue'+devices_pf_id+'" class="masterDeviceId" value="'+mapped_to_id+'" />';
						master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesText'+devices_pf_id+'" id="hdnMasterDevicesText'+devices_pf_id+'" class="masterDeviceName" value="'+mapped_to_deviceName+'" />';
						master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesManufacturer'+devices_pf_id+'" id="hdnMasterDevicesManufacturer'+devices_pf_id+'" class="manufacturerName" value="'+mapped_to_manufacturer+'" />';
						master_device_dropdown += '<input type="text" name="txtMasterDevices'+devices_pf_id+'" id="txtMasterDevices'+devices_pf_id+'" class="span5 autoCompleteDeviceName" value="'+mapped_to_deviceName+'" />';
						jQuery("#mapped_list").jqGrid('setRowData',ids[i],{action: add_button});
					}
					jQuery("#mapped_list").jqGrid('setRowData',ids[i],{master_device_id: master_device_dropdown});
					
					$(".autoCompleteDeviceName").autocomplete({
            			source: function (request, response) {
                        	$.ajax({
                            	url: "<?=$this->baseUrl();?>/data/getmodels", dataType: "json",
                                data: { searchText: request.term },
                                success: function (data) {
                                	response($.map(data, function (item) {
                                    	return {
                                        	value: item.label,
                                            id: item.value,
                                            label: item.label,
                                            manufacturer: item.manufacturer
                                        }
                                    }))
                                }
                            })
            			},
            			minLength: 0,
            			select: function( event, ui ) {
            				$(this).parent().find("input.masterDeviceId")[0].value = ui.item.id;
            				$(this).parent().find("input.masterDeviceName")[0].value = ui.item.label;
            				$(this).parent().find("input.manufacturerName")[0].value = ui.item.manufacturer;
            				
            				var textValue = $.trim(this.value);
            				var row_id = this.id.replace("txtMasterDevices","");
            				var deviceId = $.trim($(this).parent().find("input.masterDeviceId")[0].value);
            				var deviceName = $.trim($(this).parent().find("input.masterDeviceName")[0].value);
            			
            				// If the user textbox is filled
            				if (textValue) {
            					// If the device id is not set, then we reset to blank
								if (!deviceId) {
									textValue = "";
								} else {
									// Set the name to the device name
									textValue = deviceName;
                            	}
            				} else {
            					$(this).parent().find("input.masterDeviceId")[0].value = "";
								$(this).parent().find("input.masterDeviceName")[0].value = "";
								$(this).parent().find("input.manufacturerName")[0].value = "";
            				}
            				
            				this.value = textValue;
            				set_mapped(row_id);
            			},
            			open: function( event, ui ) {
                			var termTemplate = '<strong>%s</strong>';
                			var autocompleteData = $(this).data('autocomplete');
                			autocompleteData.menu.element.find('a').each(function() {
                    			var label = $(this);
                				var regex = new RegExp(autocompleteData.term, "gi");
                    			label.html( label.text().replace(regex, function (matched) {
                        			return termTemplate.replace('%s', matched);
                    			}));
                			});
        				},
            			change: function( event, ui ) {
            				var textValue = $.trim(this.value);
            				var row_id = this.id.replace("txtMasterDevices","");
            				var deviceId = $.trim($(this).parent().find("input.masterDeviceId")[0].value);
            				var deviceName = $.trim($(this).parent().find("input.masterDeviceName")[0].value);
            			
            				// If the user textbox is filled
            				if (textValue) {
            					// If the device id is not set, then we reset to blank
								if (!deviceId) {
									textValue = "";
								} else {
									// Set the name to the device name
									textValue = deviceName;
                            	}
                            	//enable edit
                            	$("#btnAdd"+row_id).removeAttr("disabled");
            				} else {
            					$(this).parent().find("input.masterDeviceId")[0].value = "";
								$(this).parent().find("input.masterDeviceName")[0].value = "";
								$(this).parent().find("input.manufacturerName")[0].value = "";
                            	$("#btnAdd"+row_id).attr("disabled","disabled");
            				}
            				
            				this.value = textValue;
            				set_mapped(row_id);
            			}
            		});
				}
			},
			editurl:'dummy.php'
		});
		
		jQuery("#mapped_list").jqGrid('navGrid','#mapped_pager',
				{add:false,del:false,edit:false,refresh:false,search:false},
				{closeAfterEdit:true,recreateForm:true,closeOnEscape:true,width:400,top:sTop,left:sLeft},
				{closeAfterAdd:true,recreateForm:true,closeOnEscape:true,width:400,top:sTop,left:sLeft},
				{},
				{},
				{}
		);
		
		if(grid_display == 'block') {
			toggle_mapped();
		}
		
        <?php if(isset($this->privilege) && in_array("System Admin", $this->privilege)) { ?>
        //hide action column
   		//jQuery("#mapped_list").hideCol("action");
   		//jQuery("#mapped_list").setGridWidth(615);
        <?php } ?>
    });

    function doAction(inAction) {
        if(inAction == 'cancel') {
			document.location.href = "<?php echo $this->baseUrl("/proposalgen/fleet"); ?>";
        }
    }
    
    function edit_device(id) {
    	var hdnId = $("#hdnMasterDevicesValue"+id).val();
    	
    	document.getElementById('hdnID').value = hdnId;
    	document.getElementById('hdnItem').value = 'master';
    	document.getElementById('hdnGrid').value = document.getElementById("mapped_list_container").style.display;
		document.getElementById('mapping').action = "<?php echo $this->url(array('action' => 'managemappingdevices', 'controller' => 'managedevices')); ?>";
    	document.getElementById('mapping').submit();
    }
	
	function add_device(id) {
    	document.getElementById('hdnID').value = id;
    	document.getElementById('hdnItem').value = '';
    	document.getElementById('hdnGrid').value = document.getElementById("mapped_list_container").style.display;
    	
	    <?php if(isset($this->privilege) && in_array("System Admin", $this->privilege)) { ?>
			document.getElementById('mapping').action = "<?php echo $this->url(array('action' => 'managemappingdevices', 'controller' => 'managedevices')); ?>";
	    <?php } else { ?>
    		document.getElementById('mapping').action = "<?php echo $this->url(array('action' => 'adddevice')); ?>";
    	<?php } ?>
    	
    	document.getElementById('mapping').submit();
	}
	
	function set_mapped(id) {
		var master_device_id = 0;
		var devices_pf_id = 0;
		
		if(document.mapping.elements['txtMasterDevices'+id]) {
			devices_pf_id = document.mapping.elements['hdnDevicesPfId'+id].value;
			master_device_id = document.mapping.elements['hdnMasterDevicesValue'+id].value;
		}
		url = '<?php echo $this->url(array('action' => 'setmappedto')); ?>?master_device_id='+master_device_id+'&devices_pf_id='+devices_pf_id;
		$.ajax ({
			type: "POST",
			contentType: "application/json; charset=utf-8",
	        url: url,
	        success: function() {
	        },
			error: function() {
				$('#message_container').html("Error setting mapped device!");
			}
		});
	}
	
	function remove_device(id, list) {
		//if(confirm("Are you sure you want to remove this device?")) {
			url = '<?php echo $this->url(array('action' => 'removedevice')); ?>?key='+id;
			$.ajax ({
				type: "POST",
				contentType: "application/json; charset=utf-8",
		        url: url,
				error: function() {
					$('#message_container').html("Error removing device!");
				},
				complete: function() {
					//refresh the page
			    	$('#'+list+'_list').trigger('reloadGrid');
			    }
			});
		//}
	}
		
	function toggle_mapped() {
		if($("#mapped_list_container").is(":visible")) {
			$("#toggle_mapped_link").html("[+] Show Mapped Printers");
			$("#mapped_list_container").hide();
			show_mapped = false;
		} else {
		 	if(show_mapped == false) {
		 		$("#mapped_list").jqGrid('setGridParam',{datatype:'json'}).trigger('reloadGrid');
				$("#toggle_mapped_link").html("[-] Hide Mapped Printers");
				$("#mapped_list_container").show();
				show_mapped = true;
			}
			grid_display = '';
		}
	}
	
<?php $this->headScript()->captureEnd() ?>

<style>
/* THIS WILL WRAP CELL DATA IN GRID */
.ui-jqgrid tr.jqgrow td {
	white-space: normal !important;
}
</style>

<table style="width: 100%;border-collapse: collapse; table-layout: fixed">
	<tr>
		<td class = "Title"><u><?php echo $this->formTitle?></u></td>
		<?php if ($this->companyName) :?>
		<td class = "PreparedFor"><i>Prepared For:</i></td>
		<td class = "PreparedForText"><i><?php echo $this->companyName; ?></i></td>
		<?php endif?>
	</tr>
</table>

<form name="mapping" id="mapping" class="fileinput" action="<?php echo $this->baseUrl(); ?>/proposalgen/fleet/savemapping" method="POST">
    <input type="hidden" name="hdnID" id="hdnID" value="" />
    <input type="hidden" name="hdnItem" id="hdnItem" value="" />
    <input type="hidden" name="hdnGrid" id="hdnGrid" value="" />
	<input type="hidden" name="form_mode" id="form_mode" value="mapping" />
	
    <dl class="zend_form">
    	<dt class="botMenu">
    	
    		<div class="message_container margined">
    		    <?php echo $this->message; ?>
    		</div>
    		
    		<?php if(isset($this->mapping_error)) { ?>
    		<div class="mapping_error_container margined">
    		    <?php echo $this->mapping_error; ?>
    		</div>
    		<?php } ?>
    				
    		<div class="results_container">
    			<?php if($this->unmapped_count > 0) { ?>
    			<div id="results_list_container">
    				<table id="results_list"></table>
    			</div>
    			<br />
    			<p><?php echo $this->mapped_count; ?> printer model(s) have been automatically mapped.</p>
    			<?php } ?>
    			<p><a id="toggle_mapped_link" href="javascript: void(0);" onclick="javascript: toggle_mapped();" style="text-decoration: none;">[+] Show Mapped Printers</a></p>
    			<div id="mapped_list_container" style="display: none;">		
    				<table id="mapped_list"></table>
    			</div>
    			<br/>
    			
    			<div class="submitBar" id="submitBtns">
    				<input type="submit" name="btnNext" id="btnNext" value="Save and continue" class="btn btn-primary" />
    				<input type="button" name="btnBack" id="btnBack" value="Back" onClick="javascript: doAction('cancel');" class="btn" />
    			</div>
    			
    		</div>
    	</dt>
    </dl>
</form>
