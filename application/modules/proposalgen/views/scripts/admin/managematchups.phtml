<?php
/**
 * managematchups.phtml
 * 
 * @author	John Sadler
 * @version	v1.0 
 */
?>
	
<?php $this->headScript()->captureStart('append','text/javascript') ?>

    $(document).ready(function() {
		//find center screen for modal popup
		var sTop = ($(window).height()/2)-100;
		var sLeft = ($(window).width()/2)-200;
		var url = '<?php echo $this->baseUrl("/proposalgen/admin/matchuplist"); ?>?filter=model&criteria=<?php echo $this->pf_model_id; ?>';

		jQuery("#grid_list").jqGrid({
			url: url,
			datatype:'json',			
			colNames:['PFID','MID','PF Model Id','<?php echo $this->source; ?> Model Name','Master Printer','MAPPED TO','MAPPED TO ID','MAPPED TO MANUFACTURER'],
			colModel:[
        		{width: 35,name:'devices_pf_id', index:'devices_pf_id', align:'center', hidden:true, title:false},
        		{width: 35, name:'master_device_id', index:'master_device_id', align:'center', hidden:true, title:false},
        		{width: 80, name:'pf_model_id', index:'pf_model_id', align:'center', title:false},
        		{width: 240, name:'user_device', index:'user_device', title:false},
				{width: 250, name:'master_device', index:'master_device', align:'center', title:false},
				{width: 50, name:'mapped_to', index:'mapped_to', hidden:true},
				{width: 50, name:'mapped_to_id', index:'mapped_to_id', hidden:true},
				{width: 50, name:'mapped_to_manufacturer', index:'mapped_to_manufacturer', hidden:true}
			],
			width:940,
			height:'auto',
			rowNum:10,
			rowList:[10,20,30],
			pager:'#grid_pager',
			gridComplete:function() {

				var ids = jQuery("#grid_list").jqGrid('getDataIDs');
				for(var i=0; i < ids.length; i++) {
					var cur_row = ids[i];
					
					//build hidden field for master_device_id
					var devices_pf_id = document.getElementById("grid_list").rows[i+1].cells[0].innerHTML;
					var master_device_id = document.getElementById("grid_list").rows[i+1].cells[1].innerHTML;
					
					hidden_devices_pf_id = "<input type='hidden' name='hdnDevicesPFID"+ids[i]+"' id='hdnDevicesPFID"+ids[i]+"' value='" + devices_pf_id + "' />";
					hidden_master_device_id = "<input type='hidden' name='hdnMasterDeviceID"+ids[i]+"' id='hdnMasterDeviceID"+ids[i]+"' value='" + master_device_id + "' />";
					
					var mapped_to = document.getElementById("grid_list").rows[i+1].cells[5].innerHTML;
					var mapped_to_id = document.getElementById("grid_list").rows[i+1].cells[6].innerHTML;
					var mapped_to_manufacturer = document.getElementById("grid_list").rows[i+1].cells[7].innerHTML;
					var mapped_to_deviceName = mapped_to_manufacturer + " " + mapped_to;
					mapped_to_deviceName = mapped_to_deviceName.replace("&nbsp; &nbsp;", "");
					
					master_device_dropdown = '';
					master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesValue'+cur_row+'" id="hdnMasterDevicesValue'+cur_row+'" class="masterDeviceId" value="'+mapped_to_id+'" />';
					master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesText'+cur_row+'" id="hdnMasterDevicesText'+cur_row+'" class="masterDeviceName" value="'+mapped_to_deviceName+'" />';
					master_device_dropdown += '<input type="hidden" name="hdnMasterDevicesText'+cur_row+'" id="hdnMasterDevicesManufacturer'+cur_row+'" class="manufacturerName" value="'+mapped_to_manufacturer+'" />';
					master_device_dropdown += '<input type="text" name="txtMasterDevices'+cur_row+'" id="txtMasterDevices'+cur_row+'" class="span5 autoCompleteDeviceName" value="'+mapped_to_deviceName+'" />';
					
					//add fields to grid
					jQuery("#grid_list").jqGrid('setRowData',ids[i],{devices_pf_id: devices_pf_id + hidden_devices_pf_id});
					jQuery("#grid_list").jqGrid('setRowData',ids[i],{master_device_id: master_device_id + hidden_master_device_id});
					jQuery("#grid_list").jqGrid('setRowData',ids[i],{master_device: master_device_dropdown});
					
            		$(".autoCompleteDeviceName").autocomplete({
            			source: function (request, response) {
                            $.ajax({
                                url: "<?=$this->baseUrl('/proposalgen/admin/getmodels');?>", dataType: "json",
                                data: { searchText: request.term },
                                success: function (data) {
                                    response($.map(data, function (item) {
                                        return {
                                            value: item.label,
                                            id: item.value,
                                            label: item.label,
                                            manufacturer: item.manufacturer
                                        }
                                    }))
                                }
                            })
            			},
            			minLength: 0,
            			select: function( event, ui ) {
            				$(this).parent().find("input.masterDeviceId")[0].value = ui.item.id;
            				$(this).parent().find("input.masterDeviceName")[0].value = ui.item.label;
            				$(this).parent().find("input.manufacturerName")[0].value = ui.item.manufacturer;
            			},
            			open: function( event, ui ) {
                			var termTemplate = '<strong>%s</strong>';
                			var autocompleteData = $(this).data('autocomplete');
                			autocompleteData.menu.element.find('a').each(function() {
                    			var label = $(this);
                				var regex = new RegExp(autocompleteData.term, "gi");
                    			label.html( label.text().replace(regex, function (matched) {
                        			return termTemplate.replace('%s', matched);
                    			}));
                			});
        				},
            			change: function( event, ui ) {
            				var textValue = $.trim(this.value);
            				var row_id = this.id.replace("txtMasterDevices","");
            				var deviceId = $.trim($(this).parent().find("input.masterDeviceId")[0].value);
            				var deviceName = $.trim($(this).parent().find("input.masterDeviceName")[0].value);
            				// If the user textbox is filled
            				if (textValue)
            				{
            					// If the device id is not set, then we reset to blank
								if (!deviceId)
								{
									textValue = "";
								}
								else
								{
									// Set the name to the device name
									textValue = deviceName;
                            	}
            				}
            				else
            				{
            					$(this).parent().find("input.masterDeviceId")[0].value = "";
								$(this).parent().find("input.masterDeviceName")[0].value = "";
								$(this).parent().find("input.manufacturerName")[0].value = "";
            				}
            				
            				this.value = textValue;
            			}
            		});
					
				}
				$("#hdnIdArray").val(ids);
			},
			editurl:'dummy.php'
		});
		
		jQuery("#grid_list").jqGrid('navGrid','#grid_pager',
			{add:false,del:false,edit:false,refresh:false,search:false},
			{closeAfterEdit:true,recreateForm:true,closeOnEscape:true,width:400,top:sTop,left:sLeft},
			{closeAfterAdd:true,recreateForm:true,closeOnEscape:true,width:400,top:sTop,left:sLeft},
			{},
			{},
			{}
		);
		
	});
	
	function update_grid(action) {
		var params = '?filter=&criteria=';
		if(action == 'search') {
			params = '?filter='+$("#criteria_filter").val()+'&criteria='+$("#txtCriteria").val();
		} else if(action == 'clear') {
			$("#criteria_filter").attr('selectedIndex', 0);
			$("#txtCriteria").val('');
		}
		
		$('#grid_list').setGridParam({url:'<?php echo $this->baseUrl("/proposalgen/admin/matchuplist"); ?>'+params});
		$('#grid_list').trigger("reloadGrid");
	}
	
	function do_action(inAction) {
		if(inAction == 'save') {
			$("#matchups").submit();
			
		} else if(inAction == 'done') {
			if($("#ticket_id").val() > 0) {
				document.location.href = '<?php echo $this->baseUrl("/proposalgen/ticket/ticketdetails") . "?id="; ?>'+$("#ticket_id").val();
			} else {
				document.location.href = '<?php echo $this->baseUrl("/proposalgen/admin"); ?>';
			}
		}
	}
	
<?php $this->headScript()->captureEnd() ?>

<h2><?php echo $this->title;?></h2>

<form name="matchups" id="matchups" action="" method="post">
<input type="hidden" name="ticket_id" id="ticket_id" value="<?php echo $this->ticket_id; ?>" />
<input type="hidden" name="devices_pf_id" id="devices_pf_id" value="<?php echo $this->devices_pf_id; ?>" />
<input type="hidden" name="form_mode" id="form_mode" value="<?php echo $this->form_mode; ?>" />
<input type="hidden" name="hdnIdArray" id="hdnIdArray" value="" />

	<dl class="zend_form">
		<dt class="botMenu">
			<div id="instruction_container" class="margined">
				<p>Please map the following <?php echo $this->source; ?> printers to a master printer.</p>
			</div>
			
			<div id="message_container" class="margined">
			    <?php echo $this->message; ?>
			</div>
			
			<div id="filter_container" class="well">
				<div id="criteria_container" style="display: inline; padding: 0px 0px 0px 0px; margin: 0px 0px 0px 0px;">
					<label for="criteria_filter" class="details_label" style="display: inline; padding: 0px 0px 0px 0px; margin: 0px 0px 0px 0px;">Filter:</label>
					<select name="criteria_filter" id="criteria_filter" class="filter_dropdown" style="width: 180px; margin: 0px 0px 0px 10px;">
						<option value="model">PF Model Id</option>
						<option value="printer">PrintFleet Model Name</option>
					</select>
					<label for="txtCriteria" class="details_label" style="display: inline; padding: 0px 0px 0px 0px; margin: 0px 10px 0px 10px;">for</label>
					<input type="text" name="txtCriteria" style="width: 180px; margin: 0px 0px 0px 0px;" id="txtCriteria" value="<?php echo $this->pf_model_id; ?>" />
					<input type="button" name="btnSearch" id="btnSearch" value="Search" onclick="javascript: update_grid('search');" class="btn" />
					<input type="button" name="btnClearSearch" id="btnClearSearch" value="Clear" onclick="javascript: update_grid('clear');" class="btn" />
				</div>
			</div>
			
			<div id="grid_container" class="margined">
				<table id="grid_list"></table>
				<div id="grid_pager"></div>
			</div>
			
			<br/>
			<div id="submitBtns" class="submitBar">
				<input type="button" name="btnUpdate" id="btnUpdate" value="Update" onclick="javascript: do_action('save');" class="btn btn-primary" />
				<input type="button" name="btnDone" id="btnDone" value="Done" onClick="javascript: do_action('done');" class="btn" />
			</div>
		</dt>
	</dl>
</form>
