<?php

// TODO: Remove hardcoded values
$filename =  "purchase-quote.docx";
$savePath = PUBLIC_PATH . "/downloads/client/{$this->clientId}/quote/{$this->quoteId}/";

if (!is_dir($savePath))
{
    if (!mkdir($savePath, 0777, true))
    {
        throw new Exception("Could not open cache folder! PATH:" . $savePath, 0);
    }
}
$savePath = $savePath . $filename;
$linkToFile = $this->baseUrl("/downloads/client/{$this->clientId}/quote/{$this->quoteId}/{$filename}");

// This may not need to be removed from here
// Base path to the files used to render the document
$basePath = 'quote/reports/purchase-quote/docx';
$commonPartsBasePath = 'quote/reports/common/' . $this->App()->theme;

$quote = $this->Quote(); /* @var $quote Quotegen_Model_Quote */

/* @var $phpword PHPWord */
$phpword = $this->phpword;

/**
 * Document Properties
 */
$properties = $phpword->getProperties();
$properties->setCreator('Demo Report');
$properties->setCompany('Demo Report');
$properties->setTitle('Demo Report');
$properties->setDescription('Demo Report');
$properties->setCategory('Demo Report');
$properties->setLastModifiedBy('Demo Report');
$properties->setCreated(time());
$properties->setModified(time());
$properties->setSubject('Demo Report');
$properties->setKeywords('demo, assessment, report');

$titlepageSection = $phpword->createSection(array (
        'orientation' => null, 
        'marginLeft' => 720, 
        'marginRight' => 720, 
        'marginTop' => 720, 
        'marginBottom' => 720 
));
$section = $phpword->createSection();

/**
 * Footer
 */
// FIXME: Footer in PHPWord is not working correctly
//$footer = $section->createFooter();
//$footer->addText("TEXT");
//$footer->addImage(PUBLIC_PATH . $this->theme('/proposalgenerator/reports/images/officedepotLogo.jpg'), array (    'align' => 'right'));

// Render our style defaults?
$this->render("{$commonPartsBasePath}/styles.phtml");


$phpword->addParagraphStyle('titleStyle1', array(
                                                'align'      => 'center',
                                                'spaceAfter' => 100,
                                                'bgColor'    => '004990'
                                           ));
$phpword->addParagraphStyle('titleStyle2', array(
                                                'spaceAfter'  => 100,
                                                'spaceBefore' => 100,
                                                'bgColor'     => '4C4C4C'
                                           ));
$phpword->addParagraphStyle('titleStyle3', array(
                                                'spaceAfter' => 200,
                                                'bgColor'    => '7F7F7F'
                                           ));
$phpword->addFontStyle('titlepage_title', array(
                                               'size'  => 24,
                                               'bold'  => true,
                                               'color' => 'FFFFFF'
                                          ));

$phpword->addFontStyle('titlepage_subtitle', array(
                                                  'size'  => 16,
                                                  'bold'  => true,
                                                  'color' => 'FFFFFF'
                                             ));

$phpword->addFontStyle('titlepage_address', array(
                                                 'size'  => 12,
                                                 'color' => 'FFFFFF'
                                            ));
$phpword->addParagraphStyle('titlepageHeaderParagraph', array(
                                                             'spaceAfter' => 200
                                                        ));
$phpword->addParagraphStyle('titlepageHeader1', array(
                                                     'spaceAfter' => 0,

                                                ));


/**
 * Paragraph styles
 */
$phpword->addParagraphStyle('titlepageHeaderParagraph', array (
        'spaceAfter' => 200 
));

$phpword->addParagraphStyle('nospacing', array (
        'spaceBefore' => 0, 
        'spaceAfter' => 0 
));

$phpword->addParagraphStyle('nospacing_rightalign', array (
        'align' => 'right', 
        'spaceBefore' => 0, 
        'spaceAfter' => 0 
));

$phpword->addParagraphStyle('nospacing_centeralign', array (
        'align' => 'center', 
        'spaceBefore' => 0, 
        'spaceAfter' => 0 
));

$phpword->addParagraphStyle('rightalign', array (
        'align' => 'right' 
));

$phpword->addParagraphStyle('gradeParagraph', array (
        'align' => 'center', 
        'spaceBefore' => 0, 
        'spaceAfter' => 0 
));

$phpword->addParagraphStyle('savingsParagraph', array (
        'align' => 'center', 
        'spaceBefore' => 0, 
        'spaceAfter' => 0 
));

/**
 * Font Styles
 */
$phpword->addFontStyle('titlepageHeaderFont', array (
        'bold' => true, 
        'size' => 16 
));

$phpword->addFontStyle('bold_text', array (
        'bold' => true 
));

$phpword->addFontStyle('bold_red_text', array (
        'bold' => true, 
        'color' => 'F00001' 
));

$phpword->addFontStyle('gradeFont', array (
        'bold' => true, 
        'size' => 18 
));

$phpword->addFontStyle('gradeTitleFont', array (
        'bold' => true, 
        'size' => 12 
));

$phpword->addFontStyle('savingsFont', array (
        'bold' => true, 
        'size' => 11 
));

$phpword->addFontStyle('savingsAmountFont', array (
        'color' => $this->docStyles->brandBaseColor, 
        'bold' => true, 
        'size' => 11 
));

$phpword->addFontStyle('small_italic_text', array (
        'color' => '333333', 
        'italic' => true, 
        'size' => 9 
));

/**
 * Header/Title Styles
 */
// H1 Style
$phpword->addTitleStyle(1, array (
        'size' => 15, 
        'color' => $this->docStyles->brandBaseColor, 
        'bold' => true 
), array (
        'borderBottomSize' => 1 
));
// H2 Style #5881BC
$phpword->addTitleStyle(2, array (
        'size' => 12, 
        'color' => 'FFFFFF', 
        'bold' => true, 
        'italic' => true 
), array (
        'bgColor' => $this->docStyles->brandBaseColor 
));
// H3 Style #5881BC
$phpword->addTitleStyle(3, array (
        'size' => 10, 
        'color' => 'FF0000', 
        'bold' => true 
), array (
        'spaceBefore' => 100, 
        'spaceAfter' => 100 
));

// H3 Style #5881BC
$phpword->addFontStyle('heading3', array (
        'size' => 10, 
        'color' => 'FF0000', 
        'bold' => true 
));

/**
 * True costs table styles
 */
$trueCostsTable = (object)array (
        "tablestyle" => array (
                'cellMarginTop' => 90, 
                'cellMarginRight' => 50, 
                'cellMarginBottom' => 90, 
                'cellMarginLeft' => 50 
        ), 
        "col1Width" => 2347.38, 
        "col2Width" => 3764.88, 
        "col3Width" => 4042.71, 
        "header" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => 'bold_text', 
                        "paragraphStyle" => 'nospacing_centeralign' 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => 'bold_text', 
                        "paragraphStyle" => 'nospacing_centeralign' 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => 'bold_text', 
                        "paragraphStyle" => 'nospacing_centeralign' 
                ) 
        ), 
        "body" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'color' => 'FF0000', 
                                'bold' => true 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => null, 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => null, 
                        "paragraphStyle" => 'nospacing' 
                ) 
        ) 
);

$purchaseQuoteTable = (object)array (
        "tablestyle" => array (
                'cellMarginTop' => 25, 
                'cellMarginRight' => 100, 
                'cellMarginBottom' => 25, 
                'cellMarginLeft' => 100 
        ), 
        "col1Width" => 2257, 
        "col2Width" => 1986, 
        "col3Width" => 3702, 
        "col4Width" => 1083, 
        "span123Width" => 7945, 
        "span23Width" => 5688, 
        "header" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => $this->docStyles->brandBaseColor, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'color' => 'FFFFFF', 
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'spaceAfter' => 0 
                        ) 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => $this->docStyles->brandBaseColor, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'color' => 'FFFFFF', 
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'spaceAfter' => 0 
                        ) 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => $this->docStyles->brandBaseColor, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'color' => 'FFFFFF', 
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'spaceAfter' => 0 
                        ) 
                ), 
                "cell4" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => $this->docStyles->brandBaseColor, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'color' => 'FFFFFF', 
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'spaceAfter' => 0 
                        ) 
                ) 
        ), 
        "device" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell4" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right' 
                        ) 
                ) 
        ), 
        "option" => (object)array (
                "rowheight" => 75, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => null, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => null, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => null, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell4" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => null, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => null, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right' 
                        ) 
                ) 
        ), 
        "subtotal" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => 'D9D9D9', 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => 'D9D9D9', 
                                "valign" => 'center', 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right', 
                                'spaceAfter' => 0 
                        ) 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "bgColor" => 'D9D9D9', 
                                "valign" => 'center', 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'bold' => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right', 
                                'spaceAfter' => 0 
                        ) 
                ) 
        ), 
        "cpp" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => 'nospacing' 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "valign" => 'center', 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right', 
                                'spaceAfter' => 0 
                        ) 
                ), 
                "cell3" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right', 
                                'spaceAfter' => 0 
                        ) 
                ) 
        ), 
        'monthlyTotal' => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF', 
                                "bgColor" => 'D9D9D9', 
                                "align" => 'right' 
                        ), 
                        "fontStyle" => array (
                                "bold" => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                "align" => 'right', 
                                'spaceAfter' => 0 
                        ) 
                ), 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "valign" => 'center', 
                                "borderColor" => 'BFBFBF', 
                                "bgColor" => 'D9D9D9' 
                        ), 
                        "fontStyle" => array (
                                "bold" => true, 
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right', 
                                'spaceAfter' => 0 
                        ) 
                ) 
        ), 
        "pages" => (object)array (
                "rowheight" => null, 
                "cell1" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right' 
                        ) 
                ),
                 
                "cell2" => (object)array (
                        "cellStyle" => array (
                                "borderTopSize" => 1, 
                                "borderRightSize" => 1, 
                                "borderBottomSize" => 1, 
                                "borderLeftSize" => 1, 
                                "borderColor" => 'BFBFBF' 
                        ), 
                        "fontStyle" => array (
                                'name' => 'Calibri', 
                                'size' => 11 
                        ), 
                        "paragraphStyle" => array (
                                'nospacing' => true, 
                                'align' => 'right',
                                'spaceAfter' => 0	
                        ) 
                ) 
        ) 
);

/**
 * Setup some styles to be used across the report
 */
$styles = (object)array (
        "tables" => (object)array (
                "truecosts" => $trueCostsTable, 
                "quoteTable" => $purchaseQuoteTable 
        ) 
);

$titledata = array (
        "phpword" => $phpword, 
        "section" => $titlepageSection, 
        "quote" => $quote, 
        "styles" => $styles 
);

$data = array (
        "phpword" => $phpword, 
        "section" => $section, 
        "quote" => $quote, 
        "styles" => $styles 
);

// Actual document pages
$this->partial("{$commonPartsBasePath}/docx/titlepage.phtml", $titledata);
$this->partial("{$commonPartsBasePath}/01_prependDocuments.phtml", $data);
$this->partial("{$basePath}/purchasequote.phtml", $data);
$this->partial("{$commonPartsBasePath}/02_appendDocuments.phtml", $data);

$objWriter = PHPWord_IOFactory::createWriter($phpword, 'Word2007');

try
{
    $objWriter->save($savePath);
}
catch ( Exception $e )
{
    echo '<pre>';
    var_dump($e);
    die();
}
?>
<?php echo $this->baseUrl($linkToFile); ?>
